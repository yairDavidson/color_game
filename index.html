<!DOCTYPE html>
<html>
<head>
  <title>Synced Red/Green Button</title>
  <style>
    #colorButton {
      width: 200px;
      height: 100px;
      font-size: 24px;
      border: none;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="colorButton">Loading...</button>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Your Supabase credentials
    const SUPABASE_URL = 'https://tbmbktcllfqzqtmublqr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRibWJrdGNsbGZxenF0bXVibHFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0ODA0OTMsImV4cCI6MjA2ODA1NjQ5M30.xkEKRXwcbieIaLTvawaQFkRRXffPQn2yjHAIZXapvj4';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const button = document.getElementById('colorButton');
    let currentColor = null;

    function updateButton(color) {
      currentColor = color;
      button.style.backgroundColor = color;
      button.textContent = `Color is ${color.toUpperCase()}`;
    }

    async function loadColor() {
      const { data, error } = await supabaseClient
        .from('color_state')
        .select('color')
        .eq('id', 1)
        .single();

      if (error) {
        console.error('Error loading color:', error);
        button.textContent = 'Error loading color';
        return;
      }

      updateButton(data.color);
    }

    button.onclick = async () => {
      const newColor = currentColor === 'red' ? 'green' : 'red';
      const { error } = await supabaseClient
        .from('color_state')
        .update({ color: newColor })
        .eq('id', 1);

      if (error) {
        console.error('Error updating color:', error);
      }
    };

    // Realtime subscription
    supabaseClient
      .channel('color_sync')
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'color_state',
          filter: 'id=eq.1'
        },
        (payload) => {
          const color = payload.new.color;
          updateButton(color);
        }
      )
      .subscribe();

    // Fallback polling every 10 seconds
    setInterval(loadColor, 10000);

    // Initial load
    loadColor();
  </script>
</body>
</html>
